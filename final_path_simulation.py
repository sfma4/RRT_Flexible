import pybullet as p
from time import sleep
import time
import pybullet_data
import math
import matplotlib.pyplot as plt
import numpy as np


p1 = np.array([[ 6.11934880e+00,  6.36954571e+00,  3.29313033e-01],
 [ 6.11578100e+00,  6.36280845e+00,  3.22891648e-01],
 [ 6.11221319e+00,  6.35607120e+00,  3.16470263e-01],
 [ 6.10864539e+00,  6.34933395e+00,  3.10048879e-01],
 [ 6.10507759e+00,  6.34259670e+00,  3.03627494e-01],
 [ 6.10150978e+00,  6.33585944e+00,  2.97206109e-01],
 [ 6.09794198e+00,  6.32912219e+00,  2.90784724e-01],
 [ 6.09437418e+00,  6.32238494e+00,  2.84363339e-01],
 [ 6.09080637e+00,  6.31564769e+00,  2.77941955e-01],
 [ 6.08723857e+00,  6.30891043e+00,  2.71520570e-01],
 [ 6.08367077e+00,  6.30217318e+00,  2.65099185e-01],
 [ 6.08010296e+00,  6.29543593e+00,  2.58677800e-01],
 [ 6.07653516e+00,  6.28869868e+00,  2.52256415e-01],
 [ 6.07296736e+00,  6.28196143e+00,  2.45835031e-01],
 [ 6.06939955e+00,  6.27522417e+00,  2.39413646e-01],
 [ 6.06583175e+00,  6.26848692e+00,  2.32992261e-01],
 [ 6.06226394e+00,  6.26174967e+00,  2.26570876e-01],
 [ 6.05869614e+00,  6.25501242e+00,  2.20149491e-01],
 [ 6.05512834e+00,  6.24827516e+00,  2.13728107e-01],
 [ 6.05156053e+00,  6.24153791e+00,  2.07306722e-01],
 [ 6.04799273e+00,  6.23480066e+00,  2.00885337e-01],
 [ 6.04442493e+00,  6.22806341e+00,  1.94463952e-01],
 [ 6.04085712e+00,  6.22132615e+00,  1.88042567e-01],
 [ 6.03728932e+00,  6.21458890e+00,  1.81621183e-01],
 [ 6.03372152e+00,  6.20785165e+00,  1.75199798e-01],
 [ 6.03015371e+00,  6.20111440e+00,  1.68778413e-01],
 [ 6.02658591e+00,  6.19437714e+00,  1.62357028e-01],
 [ 6.02301811e+00,  6.18763989e+00,  1.55935644e-01],
 [ 6.01945030e+00,  6.18090264e+00,  1.49514259e-01],
 [ 6.01588250e+00,  6.17416539e+00,  1.43092874e-01],
 [ 6.01231470e+00,  6.16742814e+00,  1.36671489e-01],
 [ 6.00874689e+00,  6.16069088e+00,  1.30250104e-01],
 [ 6.00517909e+00,  6.15395363e+00,  1.23828720e-01],
 [ 6.00161129e+00,  6.14721638e+00,  1.17407335e-01],
 [ 5.99804348e+00,  6.14047913e+00,  1.10985950e-01],
 [ 5.99447568e+00,  6.13374187e+00,  1.04564565e-01],
 [ 5.99090788e+00,  6.12700462e+00,  9.81431804e-02],
 [ 5.98734007e+00,  6.12026737e+00,  9.17217956e-02],
 [ 5.98377227e+00,  6.11353012e+00,  8.53004108e-02],
 [ 5.98020447e+00,  6.10679286e+00,  7.88790260e-02],
 [ 5.97663666e+00,  6.10005561e+00,  7.24576412e-02],
 [ 5.97306886e+00,  6.09331836e+00,  6.60362564e-02],
 [ 5.96950106e+00,  6.08658111e+00,  5.96148716e-02],
 [ 5.96593325e+00,  6.07984385e+00,  5.31934868e-02],
 [ 5.96236545e+00,  6.07310660e+00,  4.67721020e-02],
 [ 5.95879765e+00,  6.06636935e+00,  4.03507172e-02],
 [ 5.95522984e+00,  6.05963210e+00,  3.39293324e-02],
 [ 5.95166204e+00,  6.05289485e+00,  2.75079477e-02],
 [ 5.94809424e+00,  6.04615759e+00,  2.10865629e-02],
 [ 5.94452643e+00,  6.03942034e+00,  1.46651781e-02],
 [ 5.94095863e+00,  6.03268309e+00,  8.24379327e-03],
 [ 5.93739083e+00,  6.02594584e+00,  1.82240848e-03],
 [ 5.93382302e+00,  6.01920858e+00, -4.59897632e-03],
 [ 5.93025522e+00,  6.01247133e+00, -1.10203611e-02],
 [ 5.92668742e+00,  6.00573408e+00, -1.74417459e-02],
 [ 5.92311961e+00,  5.99899683e+00, -2.38631307e-02],
 [ 5.91955181e+00,  5.99225957e+00, -3.02845155e-02],
 [ 5.91598400e+00,  5.98552232e+00, -3.67059003e-02],
 [ 5.91241620e+00,  5.97878507e+00, -4.31272851e-02],
 [ 5.90884840e+00,  5.97204782e+00, -4.95486699e-02],
 [ 5.90528059e+00,  5.96531056e+00, -5.59700547e-02],
 [ 5.90171279e+00,  5.95857331e+00, -6.23914395e-02],
 [ 5.89814499e+00,  5.95183606e+00, -6.88128243e-02],
 [ 5.89457718e+00,  5.94509881e+00, -7.52342090e-02],
 [ 5.89100938e+00,  5.93836156e+00, -8.16555938e-02],
 [ 5.88744158e+00,  5.93162430e+00, -8.80769786e-02],
 [ 5.88387377e+00,  5.92488705e+00, -9.44983634e-02],
 [ 5.88030597e+00,  5.91814980e+00, -1.00919748e-01],
 [ 5.87673817e+00,  5.91141255e+00, -1.07341133e-01],
 [ 5.87317036e+00,  5.90467529e+00, -1.13762518e-01],
 [ 5.86960256e+00,  5.89793804e+00, -1.20183903e-01],
 [ 5.86603476e+00,  5.89120079e+00, -1.26605287e-01],
 [ 5.86246695e+00,  5.88446354e+00, -1.33026672e-01],
 [ 5.85889915e+00,  5.87772628e+00, -1.39448057e-01],
 [ 5.85533135e+00,  5.87098903e+00, -1.45869442e-01],
 [ 5.85176354e+00,  5.86425178e+00, -1.52290827e-01],
 [ 5.84819574e+00,  5.85751453e+00, -1.58712211e-01],
 [ 5.84462794e+00,  5.85077727e+00, -1.65133596e-01],
 [ 5.84106013e+00,  5.84404002e+00, -1.71554981e-01],
 [ 5.83749233e+00,  5.83730277e+00, -1.77976366e-01],
 [ 5.83392453e+00,  5.83056552e+00, -1.84397751e-01],
 [ 5.83035672e+00,  5.82382826e+00, -1.90819135e-01],
 [ 5.82678892e+00,  5.81709101e+00, -1.97240520e-01],
 [ 5.82322112e+00,  5.81035376e+00, -2.03661905e-01],
 [ 5.81965331e+00,  5.80361651e+00, -2.10083290e-01],
 [ 5.81608551e+00,  5.79687926e+00, -2.16504675e-01],
 [ 5.81251771e+00,  5.79014200e+00, -2.22926059e-01],
 [ 5.80894990e+00,  5.78340475e+00, -2.29347444e-01],
 [ 5.80538210e+00,  5.77666750e+00, -2.35768829e-01],
 [ 5.80181430e+00,  5.76993025e+00, -2.42190214e-01],
 [ 5.79824649e+00,  5.76319299e+00, -2.48611598e-01],
 [ 5.79467869e+00,  5.75645574e+00, -2.55032983e-01],
 [ 5.79111089e+00,  5.74971849e+00, -2.61454368e-01],
 [ 5.78754308e+00,  5.74298124e+00, -2.67875753e-01],
 [ 5.78397528e+00,  5.73624398e+00, -2.74297138e-01],
 [ 5.78040748e+00,  5.72950673e+00, -2.80718522e-01],
 [ 5.77683967e+00,  5.72276948e+00, -2.87139907e-01],
 [ 5.77327187e+00,  5.71603223e+00, -2.93561292e-01],
 [ 5.76970407e+00,  5.70929497e+00, -2.99982677e-01],
 [ 5.76613626e+00,  5.70255772e+00, -3.06404062e-01],
 [ 5.76256846e+00,  5.69582047e+00, -3.12825446e-01],
 [ 5.75900065e+00,  5.68908322e+00, -3.19246831e-01],
 [ 5.75543285e+00,  5.68234597e+00, -3.25668216e-01],
 [ 5.75186505e+00,  5.67560871e+00, -3.32089601e-01],
 [ 5.74829724e+00,  5.66887146e+00, -3.38510986e-01],
 [ 5.74472944e+00,  5.66213421e+00, -3.44932370e-01],
 [ 5.74116164e+00,  5.65539696e+00, -3.51353755e-01],
 [ 5.73759383e+00,  5.64865970e+00, -3.57775140e-01],
 [ 5.73402603e+00,  5.64192245e+00, -3.64196525e-01],
 [ 5.73045823e+00,  5.63518520e+00, -3.70617910e-01],
 [ 5.72689042e+00,  5.62844795e+00, -3.77039294e-01],
 [ 5.72332262e+00,  5.62171069e+00, -3.83460679e-01],
 [ 5.71975482e+00,  5.61497344e+00, -3.89882064e-01],
 [ 5.71618701e+00,  5.60823619e+00, -3.96303449e-01],
 [ 5.71261921e+00,  5.60149894e+00, -4.02724834e-01],
 [ 5.70905141e+00,  5.59476168e+00, -4.09146218e-01],
 [ 5.70548360e+00,  5.58802443e+00, -4.15567603e-01],
 [ 5.70191580e+00,  5.58128718e+00, -4.21988988e-01],
 [ 5.69834800e+00,  5.57454993e+00, -4.28410373e-01],
 [ 5.69478019e+00,  5.56781268e+00, -4.34831757e-01],
 [ 5.69121239e+00,  5.56107542e+00, -4.41253142e-01],
 [ 5.68764459e+00,  5.55433817e+00, -4.47674527e-01],
 [ 5.68407678e+00,  5.54760092e+00, -4.54095912e-01],
 [ 5.68050898e+00,  5.54086367e+00, -4.60517297e-01],
 [ 5.67694118e+00,  5.53412641e+00, -4.66938681e-01],
 [ 5.67337337e+00,  5.52738916e+00, -4.73360066e-01],
 [ 5.66980557e+00,  5.52065191e+00, -4.79781451e-01],
 [ 5.66623777e+00,  5.51391466e+00, -4.86202836e-01],
 [ 5.66266996e+00,  5.50717740e+00, -4.92624221e-01],
 [ 5.65910216e+00,  5.50044015e+00, -4.99045605e-01],
 [ 5.65553436e+00,  5.49370290e+00, -5.05466990e-01],
 [ 5.65196655e+00,  5.48696565e+00, -5.11888375e-01],
 [ 5.64839875e+00,  5.48022839e+00, -5.18309760e-01],
 [ 5.64483095e+00,  5.47349114e+00, -5.24731145e-01],
 [ 5.64126314e+00,  5.46675389e+00, -5.31152529e-01],
 [ 5.63769534e+00,  5.46001664e+00, -5.37573914e-01],
 [ 5.63412754e+00,  5.45327939e+00, -5.43995299e-01],
 [ 5.63055973e+00,  5.44654213e+00, -5.50416684e-01],
 [ 5.62699193e+00,  5.43980488e+00, -5.56838069e-01],
 [ 5.62342413e+00,  5.43306763e+00, -5.63259453e-01],
 [ 5.61985632e+00,  5.42633038e+00, -5.69680838e-01],
 [ 5.61628852e+00,  5.41959312e+00, -5.76102223e-01],
 [ 5.61272071e+00,  5.41285587e+00, -5.82523608e-01],
 [ 5.60915291e+00,  5.40611862e+00, -5.88944993e-01],
 [ 5.60558511e+00,  5.39938137e+00, -5.95366377e-01],
 [ 5.60201730e+00,  5.39264411e+00, -6.01787762e-01],
 [ 5.59844950e+00,  5.38590686e+00, -6.08209147e-01],
 [ 5.59488170e+00,  5.37916961e+00, -6.14630532e-01],
 [ 5.59131389e+00,  5.37243236e+00, -6.21051917e-01],
 [ 5.58774609e+00,  5.36569510e+00, -6.27473301e-01],
 [ 5.58417829e+00,  5.35895785e+00, -6.33894686e-01],
 [ 5.58061048e+00,  5.35222060e+00, -6.40316071e-01],
 [ 5.57704268e+00,  5.34548335e+00, -6.46737456e-01],
 [ 5.57347488e+00,  5.33874609e+00, -6.53158840e-01],
 [ 5.56990707e+00,  5.33200884e+00, -6.59580225e-01],
 [ 5.56633927e+00,  5.32527159e+00, -6.66001610e-01],
 [ 5.56277147e+00,  5.31853434e+00, -6.72422995e-01],
 [ 5.55920366e+00,  5.31179709e+00, -6.78844380e-01],
 [ 5.55563586e+00,  5.30505983e+00, -6.85265764e-01],
 [ 5.55206806e+00,  5.29832258e+00, -6.91687149e-01],
 [ 5.54850025e+00,  5.29158533e+00, -6.98108534e-01],
 [ 5.54493245e+00,  5.28484808e+00, -7.04529919e-01],
 [ 5.54136465e+00,  5.27811082e+00, -7.10951304e-01],
 [ 5.53779684e+00,  5.27137357e+00, -7.17372688e-01],
 [ 5.53422904e+00,  5.26463632e+00, -7.23794073e-01],
 [ 5.53066124e+00,  5.25789907e+00, -7.30215458e-01],
 [ 5.52709343e+00,  5.25116181e+00, -7.36636843e-01],
 [ 5.52352563e+00,  5.24442456e+00, -7.43058228e-01],
 [ 5.51995783e+00,  5.23768731e+00, -7.49479612e-01],
 [ 5.51639002e+00,  5.23095006e+00, -7.55900997e-01],
 [ 5.51282222e+00,  5.22421280e+00, -7.62322382e-01],
 [ 5.50925442e+00,  5.21747555e+00, -7.68743767e-01],
 [ 5.50568661e+00,  5.21073830e+00, -7.75165152e-01],
 [ 5.50211881e+00,  5.20400105e+00, -7.81586536e-01]])
path = "C:\\Users\\Shang-G14\\EE_simulation\\bullet\\bullet3\\examples\\pybullet\\gym\\pybullet_data\\"
physicsClient = p.connect(p.GUI)
p.setAdditionalSearchPath(pybullet_data.getDataPath())

boxId = p.loadURDF(path+"TwoLink_4.urdf", basePosition=[2, 0, 2],
                   baseOrientation=p.getQuaternionFromEuler([math.pi/2, math.pi/2, 0]), useFixedBase=False)


objId = p.loadURDF(path+"cube.urdf", basePosition=[7.5, 0, 2.5],
                   useFixedBase=True, globalScaling=5)
target_v = 1  # motor angular speed rad/s
# target_v = [target_v, target_v]
max_force = 1000  # max force exerted by motor
x_plot, y_plot = [], []
p.resetJointState(boxId, 0, p1[0][0])
p.resetJointState(boxId, 2, p1[0][1])
p.resetJointState(boxId, 3, p1[0][2])
time.sleep(1.5)

for i in range(len(p1)):
    p.stepSimulation()
    p.setGravity(0, 0, 0)
    x = p.getJointState(boxId, 0)[0]
    y = p.getJointState(boxId, 2)[0]
    # if abs(x - 3) < 0.1 and (y - 3) < 0.1:
    #     print('loop end', 'x =', x, y)
    #     break
    p.setJointMotorControl2(
        boxId,
        0,
        p.POSITION_CONTROL,
        p1[:, 0][i],
        target_v,
        max_force
    )
    p.setJointMotorControl2(
        boxId,
        2,
        p.POSITION_CONTROL,
        p1[:, 1][i],
        target_v,
        max_force
    )
    p.setJointMotorControl2(
        boxId,
        3,
        p.VELOCITY_CONTROL,
        force=0
    )
    time.sleep(0.01)
    x_plot.append(x)
    y_plot.append(y)
# time.sleep(0.5)
# print('xy from simulation', x_plot,
#       '\ny', y_plot)
time.sleep(1.5)

print("simulation result", p.getJointState(boxId, 0), p.getJointState(boxId, 2))
ax = plt.subplot(1, 1, 1)
ax.set_aspect(1)
ax.set_xlim(0, 10)
ax.set_ylim(0, 10)
plt.plot(
    [5, 5,
     10,
     10, 5],
    [0, 5,
     5,
     0, 0], color='r')  # 画处障碍物区域
ax.plot(x_plot, y_plot, color='purple')
plt.show()
p.resetSimulation()